<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ready for Departure - GeoGame</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <style>
        /* --- CSS STİLLERİ (Dünkü ile aynı) --- */
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background-color: #1a1a1a;
        }
        .game-header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 10vh;
            background: rgba(26, 42, 76, 0.95);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 5px 25px;
            box-sizing: border-box;
            z-index: 1000;
            border-bottom: 3px solid #ffc107;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .header-row {
            display: flex;
            justify-content: space-between;
            width: 100%;
            align-items: center;
        }
        .main-info {
            font-size: 1.4rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px black;
        }
        .departure-text { color: #4da6ff; }
        .target-text { color: #ffc107; }
        .side-info {
            font-size: 1.1rem;
            font-weight: bold;
        }
        #map {
            height: 100vh;
            width: 100%;
        }
        .leaflet-top {
            top: 10vh; 
        }
    </style>
</head>
<body>

    <div class="game-header">
        <div class="main-info">
            <span class="departure-text" id="departure-display">KALKIŞ: ...</span>
            <span> ✈️ </span>
            <span class="target-text" id="target-display">HEDEF: ...</span>
        </div>
        <div class="header-row" style="margin-top: 5px;">
            <div class="side-info">SKOR: <span id="score">0</span></div>
            <div class="side-info">SÜRE: <span id="time">90</span></div>
        </div>
    </div>

    <div id="map"></div>


    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <script>
        // --- GÜN 3: JAVASCRIPT KODLARI ---

        console.log("Gün 3 kodu başlatılıyor... Turf.js devrede.");

        // --- 1. OYUN VERİSİ (Dünkü ile aynı) ---
        const airports = [
            { code: "EHAM", name: "Amsterdam", coords: [52.308, 4.768] },
            { code: "KORD", name: "Chicago", coords: [41.974, -87.907] },
            { code: "OMDB", name: "Dubai", coords: [25.253, 55.365] }
        ];
        const targets = [
            { name: "Tokyo", coords: [35.689, 139.691] },
            { name: "New York", coords: [40.712, -74.006] },
            { name: "İstanbul", coords: [41.008, 28.978] },
            { name: "Cape Town", coords: [-33.924, 18.424] },
            { name: "Sydney", coords: [-33.868, 151.209] }
        ];

        // Global değişkenler (Oyun durumu için)
        let currentDeparture = null;
        let currentTarget = null;
        let correctBearing = null; // Hesaplanan doğru açı burada saklanacak

        // --- 2. HARİTA KURULUMU (Dünkü ile aynı) ---
        const map = L.map('map', { zoomControl: false }).setView([0, 0], 2);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri',
            maxZoom: 19
        }).addTo(map);

        // Yardımcı Fonksiyon: Rastgele sayı
        function getRandomInt(max) {
            return Math.floor(Math.random() * max);
        }


        // --- 3. OYUN MANTIĞI VE TURF.JS ENTEGRASYONU (YENİ) ---

        // Açı Hesaplama Fonksiyonu (Oyunun Beyni)
        function calculateCorrectBearing(startCoords, endCoords) {
            // 1. Koordinatları Turf.js'in anlayacağı "Point" formatına çevir.
            // Turf.js [Boylam, Enlem] (Longitude, Latitude) sırasını kullanır!
            // Bizim verimiz [Enlem, Boylam] olduğu için ters çeviriyoruz.
            const startPoint = turf.point([startCoords[1], startCoords[0]]);
            const endPoint = turf.point([endCoords[1], endCoords[0]]);

            // 2. turf.bearing() fonksiyonu ile iki nokta arasındaki açıyı hesapla.
            // Bu bize -180 ile +180 arasında bir değer verir.
            let bearing = turf.bearing(startPoint, endPoint);

            // 3. Açıyı 0-360 derece formatına (Pusula yönü) çevir.
            // Eğer açı negatifse (örn. -90 Batı), 360 ekleyerek pozitife çevir (270 Batı).
            if (bearing < 0) {
                bearing += 360;
            }

            return bearing;
        }


        // Yeni bir soru (tur) başlatan fonksiyon (GÜNCELLENDİ)
        function startNewRound() {
            console.log("--- Yeni Tur Başlıyor ---");

            // A) Rastgele Seçimler
            currentDeparture = airports[getRandomInt(airports.length)];
            // Kalkış ve hedefin aynı olmamasını garantiye al
            do {
                currentTarget = targets[getRandomInt(targets.length)];
            } while (
                currentDeparture.coords[0] === currentTarget.coords[0] &&
                currentDeparture.coords[1] === currentTarget.coords[1]
            );

            // B) Arayüzü Güncelle
            document.getElementById('departure-display').innerText = `KALKIŞ: ${currentDeparture.name} (${currentDeparture.code})`;
            document.getElementById('target-display').innerText = `HEDEF: ${currentTarget.name}`;

            // C) Haritayı Uçur
            map.flyTo(currentDeparture.coords, 13, { animate: true, duration: 2 });

            // D) GÜN 3 YENİLİĞİ: Doğru Açıyı Hesapla (Turf.js ile)
            correctBearing = calculateCorrectBearing(currentDeparture.coords, currentTarget.coords);

            // E) Test İçin Konsola Yazdır
            console.log(`Rota: ${currentDeparture.name} -> ${currentTarget.name}`);
            console.log(`Hesaplanan Doğru Açı (Bearing): ${correctBearing.toFixed(2)} derece`);
            console.log("-------------------------");
        }

        // --- 4. OYUNU BAŞLAT ---
        // Harita yüklendiğinde (veya flyTo bitince) ilk turu başlatmak daha sağlıklı olabilir
        // ama şimdilik basit tutmak için doğrudan başlatıyoruz.
        // Turf.js'in yüklenmesi için kısa bir gecikme (timeout) ekleyelim.
        setTimeout(startNewRound, 500); // 0.5 saniye bekle ve başlat

    </script>

</body>
</html>